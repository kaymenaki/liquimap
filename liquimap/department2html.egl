<html>
<head>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link rel="stylesheet" href="file:[%=getImage("liquimap.css") + "?" + 1.to(10000).random()%]"/>
</head>

<body>
<table>
	<!--Stages row-->
	<tr>
	<td class="header">Stages</td>
	[%for (stage in getVisibleStages()) { %]
	<td class="stage" style="background-color:[%=stage.colour%]"colspan="[%=stage.steps.touchpoints.flatten().size()%]">[%=stage.name%]</td>
	[%}%]
	</tr>
	
	<!--Steps row-->
	<tr>
	<td class="header">Steps</td>
	[%for (step in getVisibleSteps()) { %]
	<td class="step" style="background-color:[%=step.eContainer().colour%]" colspan="[%=step.touchpoints.size()%]">[%=step.name%]</td>
	[%}%]
	</tr>

	<!--Touchpoints row-->
	<tr>
	<td class="header">Touchpoints</td>
	[%for (touchpoint in getVisibleTouchpoints()) { %]
	[%var c=touchpoint.eContainer().eContainer().colour;%]
	<td class="touchpoint" style="color:[%=c%]; border-color:[%=c%] [%if(loopCount=1){%];border-left: 2px solid;[%}%]">[%=touchpoint.name%]</td>
	[%}%]
	</tr>
	
</table>
</body>
</html>

[%
operation getVisibleStages() {
	return Stage.all.select(stage|stage.steps.exists(step|getVisibleSteps().includes(step)));
}

operation getVisibleSteps() {
	return Step.all.select(step|step.touchpoints.
		exists(touchpoint|getVisibleTouchpoints().includes(touchpoint)));
}

operation getVisibleTouchpoints() {
	return Touchpoint.all.select(touchpoint|touchpoint.departments.includes(d));
}
%]
